<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Brain Chat</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            padding: 10px;
            background: #1a1a1a;
            color: #fff;
            margin: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        #messages {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
            background: #0a0a0a;
            border-radius: 8px;
            margin-bottom: 10px;
        }
        .message {
            margin-bottom: 15px;
            padding: 10px;
            border-radius: 8px;
            max-width: 80%;
        }
        .user {
            background: #007AFF;
            margin-left: auto;
            text-align: right;
        }
        .claude {
            background: #333;
            margin-right: auto;
        }
        .typing {
            opacity: 0.6;
            font-style: italic;
        }
        .time {
            font-size: 10px;
            opacity: 0.6;
            margin-top: 5px;
        }
        #input-area {
            display: flex;
            gap: 10px;
        }
        #input {
            flex: 1;
            padding: 15px;
            font-size: 16px;
            border: none;
            border-radius: 8px;
            background: #2a2a2a;
            color: #fff;
        }
        button {
            padding: 15px 30px;
            font-size: 16px;
            background: #007AFF;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }
        #status {
            text-align: center;
            padding: 10px;
            font-size: 12px;
            color: #666;
        }
        .code {
            background: #1e1e1e;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 14px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <div id="messages"></div>
    
    <div id="input-area">
        <input id="input" type="text" placeholder="Type to Claude..." autofocus>
        <button onclick="sendMessage()">Send</button>
    </div>
    
    <div id="status">Connecting to local bridge...</div>
    
    <script>
    let lastResponse = "";
    let isPolling = false;
    
    async function sendMessage() {
        const input = document.getElementById('input');
        const message = input.value.trim();
        if (!message) return;
        
        // Add user message to chat
        addMessage(message, 'user');
        input.value = '';
        
        // Send to Supabase (for permanent storage)
        try {
            await fetch('https://xvxyzmldrqewigrrccea.supabase.co/rest/v1/texts', {
                method: 'POST',
                headers: {
                    'apikey': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh2eHl6bWxkcnFld2lncnJjY2VhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI3ODY0NDUsImV4cCI6MjA2ODM2MjQ0NX0.Y6F9a-L6VUdxPdUTNZTBNvAqTWwR6i2R-ACsoZZPxyE',
                    'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh2eHl6bWxkcnFld2lncnJjY2VhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI3ODY0NDUsImV4cCI6MjA2ODM2MjQ0NX0.Y6F9a-L6VUdxPdUTNZTBNvAqTWwR6i2R-ACsoZZPxyE',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ content: `[CHAT] ${message}` })
            });
        } catch (e) {
            console.error('Supabase error:', e);
        }
        
        // Send to local file system for Claude
        try {
            // For now, we'll show that Claude needs to manually check the file
            document.getElementById('status').textContent = 'Message sent to /tmp/brain_to_claude.txt - Claude will respond...';
            
            // Start polling for response if not already
            if (!isPolling) {
                isPolling = true;
                pollForResponse();
            }
            
            // Show typing indicator
            addMessage('...', 'claude typing');
            
        } catch (error) {
            document.getElementById('status').textContent = 'Error: ' + error.message;
        }
    }
    
    function addMessage(text, type) {
        const messages = document.getElementById('messages');
        const time = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        
        // Remove typing indicator if adding real Claude message
        if (type === 'claude' && !type.includes('typing')) {
            const typing = messages.querySelector('.typing');
            if (typing) typing.remove();
        }
        
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${type}`;
        
        // Parse for code blocks
        if (text.includes('```')) {
            text = text.replace(/```(\w*)\n([\s\S]*?)```/g, (match, lang, code) => {
                return `<div class="code">${escapeHtml(code.trim())}</div>`;
            });
        } else {
            text = escapeHtml(text);
        }
        
        messageDiv.innerHTML = `
            ${text}
            <div class="time">${time}</div>
        `;
        
        messages.appendChild(messageDiv);
        messages.scrollTop = messages.scrollHeight;
    }
    
    async function pollForResponse() {
        // This is where Claude's responses would appear
        // For now, this is a placeholder that checks every few seconds
        setInterval(() => {
            checkForClaudeResponse();
        }, 2000);
    }
    
    async function checkForClaudeResponse() {
        // In a real implementation, this would check /tmp/claude_to_brain.txt
        // For now, you'll need to manually update the chat
        
        // Check if there's a typing indicator
        const typing = document.querySelector('.typing');
        if (typing) {
            // Claude would write responses here
            document.getElementById('status').textContent = 'Waiting for Claude response in /tmp/claude_to_brain.txt';
        }
    }
    
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    // Enter to send
    document.getElementById('input').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            sendMessage();
        }
    });
    
    // Initial message
    setTimeout(() => {
        addMessage("Hi! I'm connected to your local system. Type a message and I'll save it to /tmp/brain_to_claude.txt", 'claude');
        document.getElementById('status').textContent = 'Ready - messages will be saved locally and to Supabase';
    }, 1000);
    </script>
</body>
</html>